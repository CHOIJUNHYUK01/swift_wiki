# 동시성 프로그래밍

> 분산 처리를 어떻게 하는지에 대한 프로그래밍 방식이다.

### 네트워크 통신과 비동기 처리

네트워크 통신을 해서 데이터를 서버에 요청해서 받아온다.
이 일은 부하가 많이 걸린다.
비동기 처리를 하지 않고 한다면, 인스타같은 앱에서 스크롤을 할 때마다 버벅일 것이다.
이를 해결해주는 게 비동기 처리다.

| 동기                           | 비동기                                  |
| ------------------------------ | --------------------------------------- |
| 일이 끝나고 다음 함수로 넘어감 | 끝난 건 관심없고, 동시에 여러 함수 진행 |

### 동시성을 처리하는 방법

> 작업을 "대기행렬(큐)"에 보내기만 하면, 우리 iOS가 알아서 여러 쓰레드로 나눠서 "분산처리(동시적 처리)"를 한다.

쓰레드보다 더 차원에서 대기열 개념을 이용해 쓰레드를 관리한다.
즉, 앱에서 쓰레드를 관리하는 게 아니라, 운영체제에서 대기열의 개념을 사용해 필요한 쓰레드 객체를 만들기고 하고 없애기도 한다.

### 대기열은 2가지다.

1. DispatchQueue (GCD)
2. OperationQueue - 이는 추후 공부

직접 쓰레드를 관리하지 않고, 대기열의 개념을 이용해 작업을 분산처리하고, OS에서 알아서 쓰레드를 관리한다.
메인쓰레드(1번)이 아닌 다른 쓰레드에서 오래걸리는 작업을 쉽게 비동기적으로 동작하도록 한다.

| 병렬                                       | 동시성                                                                        |
| ------------------------------------------ | ----------------------------------------------------------------------------- |
| 물리적인 여러 쓰레드에서 동시에 일을 한다. | 메인 쓰레드가 아닌 다른 소프트웨어적인 여러 쓰레드가 동시에 일을 하는 것이다. |

우리는 동시성만 신경쓰면 된다.
병렬은 운영체제가 알아서 관리한다.

### 직렬과 동시성

직렬큐도 동시성 특징을 갖고 있다.
하지만, 서로 연관된 함수를 이어서 이전 함수의 결과값에 의존하는 형태라면 이를 직렬적으로 수행하게 만들 수 있다.

### 종류

1. 메인큐 : UI 업데이트 내용을 처리한다. 직렬큐로 이뤄져 있다.
2. 글로벌큐 : 작업에 따라 우선순위가 바뀌기도 한다. 동시큐다.
3. 커스텀큐 : 기본은 직렬큐다. 옵션으로 동시큐로 바꿀 수 있다.

### 주의사항

1. UI가 변하는 작업은 무조건 메인큐에서 해야 한다.
2. 콜백함수를 올바르게 사용해야 한다. 일이 끝났을 경우에 해당 시점을 명확히 알고, 어떤 작업을 할 필요가 있어야 하기 때문이다. 이 함수가 네트워크 데이터를 활용하는 거라면, `@escaping`키워드를 붙인 클로저로 데이터를 넘겨서 해결해야 한다.
3. 객체 내에서 비동기 코드로 활용한다면, 서로를 가리키는 메모리 누수가 발생할 수 있다. 그래서 weak, unowned 키워드를 선언해야 한다. 이는 클로저기 때문이다.
4. 동기 함수를 비동기 처리로 바꿀 수 있다.

### 최근에는 Async/await가 생겼다.

비동기 함수를 이어서 처리하면 그만큼의 들여쓰기가 생긴다.
이를 해결하기 위해 만들었다.
이전 함수 리턴 시점을 기다릴 수 있다.

### 우린 잊어선 안된다. 왜 이걸 하는지

성능과 반응성, 최적화와 관련이 되어있다. 화면의 버벅 거림의 문제를 해결하기 위한 프로그래밍 기법이다.

### 경쟁상황 / 경쟁조건 (Race Condition)

Thread-safe하지 않다.
여러 쓰레드에서 하나의 메모리에 동시 접근할 때 일어나는 문제다.
그래서 동시 접근을 하지 못하게 막는 방식이 생겼다.

근데 이게 서로 접근을 하지 못하게 된다면 다음 문제가 생긴다.

### 교착상태 (Deadlocks)

2개 이상의 쓰레드가 서로 배타적인 메모리의 사용으로 인해 메서드 작업이 종료도 못하고 일의 진행도 멈춘 상태다.

### 해결 방법

동시큐에 있는 작업을 다시 직렬큐로 보내서 처리하는 방식이다.
